

<!DOCTYPE html>


<html lang="en" >

  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" /><meta name="generator" content="Docutils 0.19: https://docutils.sourceforge.io/" />

    <title>ask-astro Apache AirflowÂ® &#8212; ask-astro 0.0.1 documentation</title>
  
  
  
  <script data-cfasync="false">
    document.documentElement.dataset.mode = localStorage.getItem("mode") || "";
    document.documentElement.dataset.theme = localStorage.getItem("theme") || "light";
  </script>
  
  <!-- Loaded before other Sphinx assets -->
  <link href="../_static/styles/theme.css?digest=365ca57ee442770a23c6" rel="stylesheet" />
<link href="../_static/styles/bootstrap.css?digest=365ca57ee442770a23c6" rel="stylesheet" />
<link href="../_static/styles/pydata-sphinx-theme.css?digest=365ca57ee442770a23c6" rel="stylesheet" />

  
  <link href="../_static/vendor/fontawesome/6.1.2/css/all.min.css?digest=365ca57ee442770a23c6" rel="stylesheet" />
  <link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-solid-900.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-brands-400.woff2" />
<link rel="preload" as="font" type="font/woff2" crossorigin href="../_static/vendor/fontawesome/6.1.2/webfonts/fa-regular-400.woff2" />

    <link rel="stylesheet" type="text/css" href="../_static/pygments.css" />
    <link rel="stylesheet" href="../_static/styles/sphinx-book-theme.css?digest=14f4ca6b54d191a8c7657f6c759bf11a5fb86285" type="text/css" />
  
  <!-- Pre-loaded scripts that we'll load fully later -->
  <link rel="preload" as="script" href="../_static/scripts/bootstrap.js?digest=365ca57ee442770a23c6" />
<link rel="preload" as="script" href="../_static/scripts/pydata-sphinx-theme.js?digest=365ca57ee442770a23c6" />
  <script src="../_static/vendor/fontawesome/6.1.2/js/all.min.js?digest=365ca57ee442770a23c6"></script>

    <script data-url_root="../" id="documentation_options" src="../_static/documentation_options.js"></script>
    <script src="../_static/doctools.js"></script>
    <script src="../_static/sphinx_highlight.js"></script>
    <script src="../_static/scripts/sphinx-book-theme.js?digest=5a5c038af52cf7bc1a1ec88eea08e6366ee68824"></script>
    <script>DOCUMENTATION_OPTIONS.pagename = 'airflow/README';</script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="prev" title="Create an ask-astro Slack bot" href="../api/setup_slack_bot.html" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <meta name="docsearch:language" content="en"/>
  </head>
  
  
  <body data-bs-spy="scroll" data-bs-target=".bd-toc-nav" data-offset="180" data-bs-root-margin="0px 0px -60%" data-default-mode="">

  
  
  <a class="skip-link" href="#main-content">Skip to main content</a>
  
  <div id="pst-scroll-pixel-helper"></div>

  
  <button type="button" class="btn rounded-pill" id="pst-back-to-top">
    <i class="fa-solid fa-arrow-up"></i>
    Back to top
  </button>

  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__primary"
          id="__primary"/>
  <label class="overlay overlay-primary" for="__primary"></label>
  
  <input type="checkbox"
          class="sidebar-toggle"
          name="__secondary"
          id="__secondary"/>
  <label class="overlay overlay-secondary" for="__secondary"></label>
  
  <div class="search-button__wrapper">
    <div class="search-button__overlay"></div>
    <div class="search-button__search-container">
<form class="bd-search d-flex align-items-center"
      action="../search.html"
      method="get">
  <i class="fa-solid fa-magnifying-glass"></i>
  <input type="search"
         class="form-control"
         name="q"
         id="search-input"
         placeholder="Search..."
         aria-label="Search..."
         autocomplete="off"
         autocorrect="off"
         autocapitalize="off"
         spellcheck="false"/>
  <span class="search-button__kbd-shortcut"><kbd class="kbd-shortcut__modifier">Ctrl</kbd>+<kbd>K</kbd></span>
</form></div>
  </div>
  
    <nav class="bd-header navbar navbar-expand-lg bd-navbar">
    </nav>
  
  <div class="bd-container">
    <div class="bd-container__inner bd-page-width">
      
      <div class="bd-sidebar-primary bd-sidebar">
        

  
  <div class="sidebar-header-items sidebar-primary__section">
    
    
    
    
  </div>
  
    <div class="sidebar-primary-items__start sidebar-primary__section">
        <div class="sidebar-primary-item">
  

<a class="navbar-brand logo" href="../index.html">
  
  
  
  
  
  
    <p class="title logo__title">ask-astro 0.0.1 documentation</p>
  
</a></div>
        <div class="sidebar-primary-item"><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item navbar-nav active">
        <ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../local_development.html">Setup Local Development Tool</a></li>
<li class="toctree-l1"><a class="reference internal" href="../monitoring.html">Monitoring and Observability for Ask-Astro</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">ðŸ’» Develop UI</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../ui/README.html">Ask-Astro UI</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">ðŸ’» Develop Backend Server</span></p>
<ul class="nav bd-sidenav">
<li class="toctree-l1"><a class="reference internal" href="../api/README.html">Ask Astro Backend API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/cloudbuild_and_run.html">Backend API CI/CD</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/google_firestore.html">Setting Up Firestore for the Ask Astro Application on Google Cloud Run</a></li>
<li class="toctree-l1"><a class="reference internal" href="../api/setup_slack_bot.html">Create an ask-astro Slack bot</a></li>
</ul>
<p aria-level="2" class="caption" role="heading"><span class="caption-text">ðŸ’» Develop Apache AirflowÂ® DAGs</span></p>
<ul class="current nav bd-sidenav">
<li class="toctree-l1 current active"><a class="current reference internal" href="#">ask-astro Apache AirflowÂ®</a></li>
</ul>

    </div>
</nav></div>
    </div>
  
  
  <div class="sidebar-primary-items__end sidebar-primary__section">
  </div>
  
  <div id="rtd-footer-container"></div>


      </div>
      
      <main id="main-content" class="bd-main">
        
        

<div class="sbt-scroll-pixel-helper"></div>

          <div class="bd-content">
            <div class="bd-article-container">
              
              <div class="bd-header-article">
<div class="header-article-items header-article__inner">
  
    <div class="header-article-items__start">
      
        <div class="header-article-item"><label class="sidebar-toggle primary-toggle btn btn-sm" for="__primary" title="Toggle primary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
  <span class="fa-solid fa-bars"></span>
</label></div>
      
    </div>
  
  
    <div class="header-article-items__end">
      
        <div class="header-article-item">

<div class="article-header-buttons">





<div class="dropdown dropdown-download-buttons">
  <button class="btn dropdown-toggle" type="button" data-bs-toggle="dropdown" aria-expanded="false" aria-label="Download this page">
    <i class="fas fa-download"></i>
  </button>
  <ul class="dropdown-menu">
      
      
      
      <li><a href="../_sources/airflow/README.md" target="_blank"
   class="btn btn-sm btn-download-source-button dropdown-item"
   title="Download source file"
   data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file"></i>
  </span>
<span class="btn__text-container">.md</span>
</a>
</li>
      
      
      
      
      <li>
<button onclick="window.print()"
  class="btn btn-sm btn-download-pdf-button dropdown-item"
  title="Print to PDF"
  data-bs-placement="left" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-file-pdf"></i>
  </span>
<span class="btn__text-container">.pdf</span>
</button>
</li>
      
  </ul>
</div>




<button onclick="toggleFullScreen()"
  class="btn btn-sm btn-fullscreen-button"
  title="Fullscreen mode"
  data-bs-placement="bottom" data-bs-toggle="tooltip"
>
  

<span class="btn__icon-container">
  <i class="fas fa-expand"></i>
  </span>

</button>


<script>
document.write(`
  <button class="btn btn-sm navbar-btn theme-switch-button" title="light/dark" aria-label="light/dark" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="theme-switch nav-link" data-mode="light"><i class="fa-solid fa-sun fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="dark"><i class="fa-solid fa-moon fa-lg"></i></span>
    <span class="theme-switch nav-link" data-mode="auto"><i class="fa-solid fa-circle-half-stroke fa-lg"></i></span>
  </button>
`);
</script>

<script>
document.write(`
  <button class="btn btn-sm navbar-btn search-button search-button__button" title="Search" aria-label="Search" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <i class="fa-solid fa-magnifying-glass fa-lg"></i>
  </button>
`);
</script>
<label class="sidebar-toggle secondary-toggle btn btn-sm" for="__secondary"title="Toggle secondary sidebar" data-bs-placement="bottom" data-bs-toggle="tooltip">
    <span class="fa-solid fa-list"></span>
</label>
</div></div>
      
    </div>
  
</div>
</div>
              
              

<div id="jb-print-docs-body" class="onlyprint">
    <h1>ask-astro Apache AirflowÂ®</h1>
    <!-- Table of contents -->
    <div id="print-main-content">
        <div id="jb-print-toc">
            
            <div>
                <h2> Contents </h2>
            </div>
            <nav aria-label="Page">
                <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ingest-and-embedding">Ingest and Embedding</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#prerequisites">Prerequisites</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setup">Setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#feedback">Feedback</a></li>
</ul>
            </nav>
        </div>
    </div>
</div>

              
                
<div id="searchbox"></div>
                <article class="bd-article" role="main">
                  
  <br />
<p align="center">
  <img src="../_static/ingestion.png" />
</p>
<br />
<section id="ask-astro-apache-airflow">
<h1>ask-astro Apache AirflowÂ®<a class="headerlink" href="#ask-astro-apache-airflow" title="Permalink to this heading">#</a></h1>
<p>Ask Astro is an open-source reference implementation of <a class="reference external" href="https://a16z.com/emerging-architectures-for-llm-applications/">Andreessen Horowitzâ€™s LLM Application Architecture</a> built by <a class="reference external" href="https://astronomer.io">Astronomer</a>. It provides an end-to-end example of a Q&amp;A LLM application used to answer questions about <a class="reference external" href="https://airflow.apache.org/">Apache AirflowÂ®</a> and Astronomer.</p>
<section id="ingest-and-embedding">
<h2>Ingest and Embedding<a class="headerlink" href="#ingest-and-embedding" title="Permalink to this heading">#</a></h2>
<p>In order to make the responses as factual and accurate as possible, Ask Astro uses <a class="reference external" href="https://proceedings.neurips.cc/paper/2020/hash/6b493230205f780e1bc26945df7481e5-Abstract.html">Retrieval Augmented Generation (RAG)</a>. Use the following setup procedures to ingest and embed documents for RAG with Apache Airflow and Astro.</p>
<p>Ask Astro uses a set of Airflow DAGs that ingests data from a source via an API or Python library, preprocesses and splits the data into smaller chunks, embeds those chunks, and writes the embeddings to Weaviate. Ask Astro retrieves data from the following sources:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://airflow.apache.org/docs/">Apache AirflowÂ® docs</a></p></li>
<li><p><a class="reference external" href="https://docs.astronomer.io">Astronomer docs</a></p></li>
<li><p><a class="reference external" href="https://www.astronomer.io/blog/">Astronomer blog</a></p></li>
<li><p><a class="reference external" href="https://registry.astronomer.io">Astronomer Registry</a></p></li>
<li><p><a class="reference external" href="https://github.com/apache/airflow">Apache AirflowÂ® GitHub</a> issues and pull requests</p></li>
<li><p><a class="reference external" href="https://github.com/OpenLineage/OpenLineage">OpenLineage GitHub</a></p></li>
<li><p><a class="reference external" href="https://github.com/OpenLineage/docs">OpenLineage GitHub docs</a></p></li>
<li><p>Apache AirflowÂ® Slackâ€™s <a class="reference external" href="https://app.slack.com/client/TCQ18L22Z/CCQ7EGB1P">#troubleshooting channel</a></p></li>
<li><p><a class="reference external" href="https://archive.org/details/stackexchange">StackOverflowâ€™s Stack Exchange Data Dump</a></p></li>
<li><p><a class="reference external" href="https://docs.astronomer.io/astro/cli/overview">astro-cli</a></p></li>
</ul>
<p>Generally, each of these sources has a DAG that handles the ingestion flow. Ask Astro uses LangChainâ€™s built-in text splitters for processing Markdown, RST, and Python code into smaller chunks to ensure each document is small enough to give accurate results when embedding. Ask Astro then uses a custom-built a Weaviate provider, that will be published later, to both embed and store each document as a vector in Weaviate using OpenAIâ€™s embedding model.</p>
<p>In addition to the individual DAGs per source, Ask Astro uses one DAG to do full-database refresh based on a baseline of all extracted data sources. The first time the <code class="docutils literal notranslate"><span class="pre">ask-astro-load-bulk</span></code> DAG runs, it saves extracted documents in parquet files for a point-in-time baseline. This baseline allows us to experiment with new vector databases, embedding models, chunking strategies, much more quickly than without a baseline to compare new versions against.</p>
<p>Additionally, a baseline of pre-embedded data provides the ability to ingest a stable baseline for upstream evaluation, which is described in Step 5 of the following procedure.</p>
<p align="center">
  <img src="../_static/DAG.png" />
</p>
</section>
<section id="prerequisites">
<h2>Prerequisites<a class="headerlink" href="#prerequisites" title="Permalink to this heading">#</a></h2>
<p>There are many options for LLMs and vector databases. This template currently uses Microsoft Azure OpenAI for the LLMs and Weaviate vector database. To use this template you need the following:</p>
<ul class="simple">
<li><p>Docker Desktop or similar Docker services running locally with the docker CLI installed.</p></li>
<li><p><a class="reference external" href="https://platform.openai.com/signup">OpenAI account</a> (optional)</p></li>
<li><p><a class="reference external" href="https://www.astronomer.io/try-astro/">Astronomer account</a> (optional)</p></li>
<li><p><a class="reference external" href="https://console.weaviate.cloud/">Weaviate account</a> (optional)</p></li>
</ul>
</section>
<section id="setup">
<h2>Setup<a class="headerlink" href="#setup" title="Permalink to this heading">#</a></h2>
<ol class="arabic simple">
<li><p>Install Astronomerâ€™s <a class="reference external" href="https://github.com/astronomer/astro-cli">Astro CLI</a>. The Astro CLI is an Apache 2.0 licensed, open-source tool for building Airflow instances and provides the fastest and easiest way to be up and running with Airflow in minutes. The Astro CLI is a Docker Compose-based tool and integrates easily with Weaviate for a local developer environment.</p></li>
</ol>
<p>To install the Astro CLI, open a terminal window and run:</p>
<p>For MacOS</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>brew<span class="w"> </span>install<span class="w"> </span>astro
</pre></div>
</div>
<p>For Linux</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>curl<span class="w"> </span>-sSL<span class="w"> </span>install.astronomer.io<span class="w"> </span><span class="p">|</span><span class="w"> </span>sudo<span class="w"> </span>bash<span class="w"> </span>-s
</pre></div>
</div>
<ol class="arabic simple" start="2">
<li><p>Clone this repository:</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>git<span class="w"> </span>clone<span class="w"> </span>https://github.com/astronomer/ask-astro
<span class="nb">cd</span><span class="w"> </span>ask-astro
</pre></div>
</div>
<ol class="arabic simple" start="3">
<li><p>Create a file called <code class="docutils literal notranslate"><span class="pre">airflow/.env</span></code> with the following connection strings and environment variables.</p></li>
</ol>
<ul>
<li><p><code class="docutils literal notranslate"><span class="pre">ASK_ASTRO_ENV</span></code>: This environment variable tallows you to switch easily between local development and hosted test/prod instances For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ASK_ASTRO_ENV</span><span class="o">=</span><span class="s1">&#39;local&#39;</span>
</pre></div>
</div>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">AIRFLOW_CONN_GITHUB_RO</span></code>: Add a github <a class="reference external" href="https://docs.github.com/en/authentication/keeping-your-account-and-data-secure/managing-your-personal-access-tokens">personal access token</a>. The token needs NO PRIVILEGES for the example DAGs since it reads from public repos. If you add another private repo, use a token with read privileges for that repo.
Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">AIRFLOW_CONN_GITHUB_RO</span><span class="o">=</span><span class="s1">&#39;{&quot;conn_type&quot;: &quot;github&quot;, &quot;password&quot;: &quot;ghp_xxxxxxxxxxxxxx&quot;}&#39;</span>
</pre></div>
</div>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">AIRFLOW_CONN_WEAVIATE_LOCAL</span></code>: Add OpenAI keys for embedding ingest and for data query.
â€“ <code class="docutils literal notranslate"><span class="pre">X-Azure-Api-Key</span></code>: Specify for OpenAI endpoints with Microsoft Azure.
â€“ <code class="docutils literal notranslate"><span class="pre">X-OpenAI-Api-Key</span></code>: Specify for public OpenAI endpoints.
Example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">AIRFLOW_CONN_WEAVIATE_LOCAL</span><span class="o">=</span><span class="s1">&#39;{&quot;conn_type&quot;: &quot;weaviate&quot;, &quot;host&quot;: &quot;http://weaviate:8081&quot;, &quot;extra&quot;: {&quot;X-OpenAI-Api-Key&quot;: &quot;sk-xxxxxxx&quot;}}&#39;</span>
</pre></div>
</div>
</li>
<li><p><code class="docutils literal notranslate"><span class="pre">AIRFLOW_CONN_SLACK_API_RO</span></code>: (Optional) Add a Slack token for reading Slack messages from the desired channel. You donâ€™t need a Slack token for the bulk ingest of the Airflow <code class="docutils literal notranslate"><span class="pre">troubleshooting</span></code> channel, because a baseline from Slack archives is used.</p></li>
</ul>
<ol class="arabic simple" start="4">
<li><p><strong>Update the schema</strong>: The template includes a single document class called <code class="docutils literal notranslate"><span class="pre">Docs</span></code>. This is to simplify the reference architecture and, even with a simple schema, Ask Astro performs very well. When building a new use case from the reference architecture, it is likely  necessary to optimize the schema for the specific document types and use case.</p></li>
</ol>
<p>The Weaviate schema specifies LLM models to use for <a class="reference external" href="https://weaviate.io/developers/weaviate/modules/retriever-vectorizer-modules/text2vec-openai">embedding</a>. This repo provides a sample schema in the <code class="docutils literal notranslate"><span class="pre">airflow/include/data/schema.json</span></code> file based on OpenAI endpoints.</p>
<p>For Microsoft Azure OpenAI endpoints, edit the schema file and change the <code class="docutils literal notranslate"><span class="pre">text2vec-openai</span></code> module settings to the following. Use your specific <code class="docutils literal notranslate"><span class="pre">resourceName</span></code> and <code class="docutils literal notranslate"><span class="pre">deploymentId</span></code>:</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="nt">&quot;text2vec-openai&quot;</span><span class="p">:</span><span class="w"> </span><span class="p">{</span>
<span class="w">  </span><span class="nt">&quot;resourceName&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;xxxxxxxxxxxx&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;deploymentId&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;xxxxxxxxxxxx&quot;</span><span class="p">,</span>
<span class="w">  </span><span class="nt">&quot;vectorizeClassName&quot;</span><span class="p">:</span><span class="w"> </span><span class="s2">&quot;False&quot;</span>
<span class="p">},</span>
</pre></div>
</div>
<p>Basic functionality of ingest and embedding only requires a <a class="reference external" href="https://weaviate.io/developers/weaviate/modules/retriever-vectorizer-modules#vectorization-with-text2vec--modules">vectorizer module</a>. The Streamlit application will use the OpenAI key for <a class="reference external" href="https://weaviate.io/developers/weaviate/modules/reader-generator-modules/generative-openai">generative search</a> and <a class="reference external" href="https://weaviate.io/developers/weaviate/modules/reader-generator-modules/qna-openai">Q&amp;A</a>.</p>
<ol class="arabic simple" start="5">
<li><p>(Optional) Use pre-embedded baseline: The <code class="docutils literal notranslate"><span class="pre">ask_astro_load_bulk</span></code> DAG optionally uses a seeded baseline of pre-embedded data for RAG evaluation purposes. To ingest from the seeded baseline:</p></li>
</ol>
<ul class="simple">
<li><p>Open the file <code class="docutils literal notranslate"><span class="pre">include/dags/ask_astro_load.py</span></code></p></li>
<li><p>Set the <code class="docutils literal notranslate"><span class="pre">seed_baseline</span></code> variable to <code class="docutils literal notranslate"><span class="pre">https://astronomer-demos-public-readonly.s3.us-west-2.amazonaws.com/ask-astro/baseline_data_v2.parquet</span></code></p></li>
<li><p>Save the file</p></li>
</ul>
<ol class="arabic simple" start="6">
<li><p>Start Apache Airflow and Weaviate</p></li>
</ol>
<div class="highlight-sh notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>airflow
astro<span class="w"> </span>dev<span class="w"> </span>start
</pre></div>
</div>
<p>The Astro CLI uses Docker Compose to instantiate a local containerized instance of Airflow. Weaviate also provides a containerized version for local development, which integrates easily with Astro. See the Weaviate section in the file <code class="docutils literal notranslate"><span class="pre">airflow/include/docker-compose.override.yml</span></code> for details.</p>
<p>After Airflow starts a browser window that should open to <a class="reference external" href="http://localhost:8080">http://localhost:8080</a>. Log in with the following credentials:</p>
<ul class="simple">
<li><p><strong>username</strong>: <code class="docutils literal notranslate"><span class="pre">admin</span></code></p></li>
<li><p><strong>password</strong>: <code class="docutils literal notranslate"><span class="pre">admin</span></code></p></li>
</ul>
<ol class="arabic simple" start="7">
<li><p>Run the <code class="docutils literal notranslate"><span class="pre">ask_astro_load_bulk</span></code> DAG:</p></li>
</ol>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>astro<span class="w"> </span>dev<span class="w"> </span>run<span class="w"> </span>dags<span class="w"> </span>unpause<span class="w"> </span>ask_astro_load_bulk
astro<span class="w"> </span>dev<span class="w"> </span>run<span class="w"> </span>dags<span class="w"> </span>trigger<span class="w"> </span>ask_astro_load_bulk
</pre></div>
</div>
<p>Due to the number of document sources and API rate limits some of the tasks need to run serially or with multiple retries, the first time the DAG runs it can take ~25min for the extract and split steps. These extracted documents are serialized during the first process, and subsequent runs finish faster.</p>
<p>Follow the status of the DAG run in the <a class="reference external" href="http://localhost:8080/dags/ask_astro_load_bulk/grid">Airflow UI</a>, which you can access with the same credentials. (username: <code class="docutils literal notranslate"><span class="pre">admin</span></code>, password: <code class="docutils literal notranslate"><span class="pre">admin</span></code>)</p>
<ol class="arabic simple" start="8">
<li><p>Open the <a class="reference external" href="https://link.weaviate.io/48TqGKz">Weaviate console</a> to query the local instance.</p></li>
<li><p>The template includes incremental ingest DAGs for each data source type. These DAGs run periodically (nightly) to ingest new documents after the bulk ingest. These DAGs use the same logic as the bulk ingest for extraction (see <code class="docutils literal notranslate"><span class="pre">airflow/include/tasks/extract.py</span></code>), document splitting (see <code class="docutils literal notranslate"><span class="pre">airflow/include/tasks/split.py</span></code>), and ingestion (see <code class="docutils literal notranslate"><span class="pre">airflow/include/tasks/ingest.py</span></code>).</p></li>
</ol>
<p>Unpause the incremental ingest DAGs to see how they ingest and upsert any documents that have changed. If you manually run these DAGs directly after the bulk ingest, it is unlikely that many documents have changed, and there wonâ€™t be many updates. In this scenario, when you look at the logs for the <code class="docutils literal notranslate"><span class="pre">import_data</span></code> tasks, you see that ingestion of most documents is <strong>Skipped</strong>.</p>
<ol class="arabic simple" start="10">
<li><p>Update the DAGs with other sources.</p></li>
</ol>
<ul class="simple">
<li><p>The Airflow ingest DAGs use <a class="reference external" href="https://docs.astronomer.io/learn/dynamic-tasks">dynamic tasks</a> to iterate over multiple document sources. For example, the bulk ingest DAG, <code class="docutils literal notranslate"><span class="pre">airflow/include/dags/ingest/ask-astro-load.py</span></code>, specifies markdown sources in GitHub repositories.</p></li>
</ul>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">markdown_docs_sources</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s2">&quot;doc_dir&quot;</span><span class="p">:</span> <span class="s2">&quot;learn&quot;</span><span class="p">,</span> <span class="s2">&quot;repo_base&quot;</span><span class="p">:</span> <span class="s2">&quot;astronomer/docs&quot;</span><span class="p">},</span>
    <span class="p">{</span><span class="s2">&quot;doc_dir&quot;</span><span class="p">:</span> <span class="s2">&quot;astro&quot;</span><span class="p">,</span> <span class="s2">&quot;repo_base&quot;</span><span class="p">:</span> <span class="s2">&quot;astronomer/docs&quot;</span><span class="p">},</span>
<span class="p">]</span>
</pre></div>
</div>
<p>To ingest markdown documents from additional repositories, add the source and re-run the DAG.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">markdown_docs_sources</span> <span class="o">=</span> <span class="p">[</span>
    <span class="p">{</span><span class="s2">&quot;doc_dir&quot;</span><span class="p">:</span> <span class="s2">&quot;learn&quot;</span><span class="p">,</span> <span class="s2">&quot;repo_base&quot;</span><span class="p">:</span> <span class="s2">&quot;astronomer/docs&quot;</span><span class="p">},</span>
    <span class="p">{</span><span class="s2">&quot;doc_dir&quot;</span><span class="p">:</span> <span class="s2">&quot;astro&quot;</span><span class="p">,</span> <span class="s2">&quot;repo_base&quot;</span><span class="p">:</span> <span class="s2">&quot;astronomer/docs&quot;</span><span class="p">},</span>
    <span class="p">{</span><span class="s2">&quot;doc_dir&quot;</span><span class="p">:</span> <span class="s2">&quot;base&quot;</span><span class="p">,</span> <span class="s2">&quot;repo_base&quot;</span><span class="p">:</span> <span class="s2">&quot;OpenLineage/docs&quot;</span><span class="p">},</span>
    <span class="p">{</span><span class="s2">&quot;doc_dir&quot;</span><span class="p">:</span> <span class="s2">&quot;base&quot;</span><span class="p">,</span> <span class="s2">&quot;repo_base&quot;</span><span class="p">:</span> <span class="s2">&quot;OpenLineage/OpenLineage&quot;</span><span class="p">},</span>
<span class="p">]</span>
</pre></div>
</div>
<ul class="simple">
<li><p>The extract logic for each data source is specified in <code class="docutils literal notranslate"><span class="pre">airflow/include/tasks/extract.py</span></code>.  You can copy and paste these functions to select new sources.
For example, the <code class="docutils literal notranslate"><span class="pre">extract_astro_blogs</span></code> function shows how to use Python <a class="reference external" href="https://pypi.org/project/requests/">requests</a> and <a class="reference external" href="https://pypi.org/project/beautifulsoup4/">Beautiful Soup</a> libraries to extract blog posts from http://astronomer.io/blog. You can adapt this code to ingeset from other sources.</p></li>
</ul>
<ol class="arabic simple" start="11">
<li><p>Ingest to Test: You can make a free Weaviate Sandbox cluster with a trial account. The sandbox provides a free 14-day temporary cluster. After creating the sandbox cluster, note the <strong>Cluster URL</strong> and the <strong>Admin API Key</strong>.</p></li>
</ol>
<ul class="simple">
<li><p>Open the <code class="docutils literal notranslate"><span class="pre">airflow/.env</span></code> file and update the following:
â€“ <code class="docutils literal notranslate"><span class="pre">ASK_ASTRO_ENV</span></code>: Set it to <code class="docutils literal notranslate"><span class="pre">test</span></code>
â€“ <code class="docutils literal notranslate"><span class="pre">AIRFLOW_CONN_WEAVIATE_TEST</span></code>: Update the host and token with the sandbox <strong>Cluster URL</strong> and the <strong>Admin API Key</strong>. The OpenAI key should be the same as in the <strong>local</strong> setting.</p></li>
<li><p>Restart Astro with the new environment variables.</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>astro<span class="w"> </span>dev<span class="w"> </span>restart
</pre></div>
</div>
<ul class="simple">
<li><p>Rerun the bulk ingest DAG</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>astro<span class="w"> </span>dev<span class="w"> </span>run<span class="w"> </span>dags<span class="w"> </span>unpause<span class="w"> </span>ask_astro_load_bulk
astro<span class="w"> </span>dev<span class="w"> </span>run<span class="w"> </span>dags<span class="w"> </span>trigger<span class="w"> </span>ask_astro_load_bulk
</pre></div>
</div>
<p>This time when the DAG runs it uses the serialized extracted documents, and can run much faster. Only the <code class="docutils literal notranslate"><span class="pre">import_data</span></code> tasks take time. Look in the task logs for this task to note that it now uses the <code class="docutils literal notranslate"><span class="pre">test</span></code> cluster. For example:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="mi">2023</span><span class="o">-</span><span class="mi">10</span><span class="o">-</span><span class="mi">17</span><span class="p">,</span> <span class="mi">12</span><span class="p">:</span><span class="mi">26</span><span class="p">:</span><span class="mi">21</span> <span class="n">UTC</span><span class="p">]</span> <span class="p">{</span><span class="n">base</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">73</span><span class="p">}</span> <span class="n">INFO</span> <span class="o">-</span> <span class="n">Using</span> <span class="n">connection</span> <span class="n">ID</span> <span class="s1">&#39;weaviate_test&#39;</span> <span class="k">for</span> <span class="n">task</span> <span class="n">execution</span><span class="o">.</span>
</pre></div>
</div>
<p>As the DAG runs, you can see the document count increasing in the <a class="reference external" href="https://console.weaviate.cloud">Weaviate Console</a> with a query :</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">{</span> <span class="n">Aggregate</span> <span class="p">{</span> <span class="n">Docs</span> <span class="p">{</span> <span class="n">meta</span> <span class="p">{</span> <span class="n">count</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}</span> <span class="p">}</span>
</pre></div>
</div>
<p>After integration testing with the front end, the sandbox cluster can be removed.</p>
<ol class="arabic simple" start="12">
<li><p>Promote to production: Step 10 shows an example of switching between different Weaviate instances. Follow the same approach to point Airflow at a <code class="docutils literal notranslate"><span class="pre">production</span></code> or non-temporary Weaviate sandbox. Complete the following steps to promote from Airflow running locally to a production deployment in Astro.</p></li>
</ol>
<ul class="simple">
<li><p>Create a free <a class="reference external" href="https://docs.astronomer.io/astro/trial">Astro trial</a> account, organization, and deployment.</p></li>
<li><p>Log in to Astro from the CLI.</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>astro<span class="w"> </span>login
</pre></div>
</div>
<ul class="simple">
<li><p><a class="reference external" href="https://docs.astronomer.io/astro/deploy-code">Deploy</a> the Astro project.</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>astro<span class="w"> </span>deployment<span class="w"> </span>create<span class="w"> </span>-n<span class="w"> </span><span class="s1">&#39;ask astro dev&#39;</span>
astro<span class="w"> </span>deployment<span class="w"> </span>variable<span class="w"> </span>update<span class="w"> </span>-lsn<span class="w"> </span><span class="s1">&#39;ask astro dev&#39;</span>
astro<span class="w"> </span>deployment<span class="w"> </span>variable<span class="w"> </span>update<span class="w"> </span>-n<span class="w"> </span><span class="s1">&#39;ask astro dev&#39;</span><span class="w"> </span><span class="nv">ASK_ASTRO_ENV</span><span class="o">=</span>dev
astro<span class="w"> </span>deploy<span class="w"> </span>-fn<span class="w"> </span><span class="s1">&#39;ask astro dev&#39;</span>
</pre></div>
</div>
<ol class="arabic simple" start="13">
<li><p>Query the Data: This template also includes a simple Streamlit application to query the data. For this application to work, you need to provide an OpenAI key with the Weaviate connection string.</p></li>
</ol>
<ul class="simple">
<li><p>(Optional) Check the configuration in your <code class="docutils literal notranslate"><span class="pre">.env</span></code> file for <code class="docutils literal notranslate"><span class="pre">AIRFLOW_CONN_WEAVIATE_LOCAL</span></code> that you made in Step 3 to confirm that you added an OpenAI Admin Key.</p></li>
<li><p>Connect to the webserver container with the Astro CLI</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>astro<span class="w"> </span>dev<span class="w"> </span>bash<span class="w"> </span>-w
</pre></div>
</div>
<ul class="simple">
<li><p>Start Streamlit</p></li>
</ul>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>include/streamlit
python<span class="w"> </span>-m<span class="w"> </span>streamlit<span class="w"> </span>run<span class="w"> </span>./streamlit_app.py
</pre></div>
</div>
</section>
<section id="feedback">
<h2>Feedback<a class="headerlink" href="#feedback" title="Permalink to this heading">#</a></h2>
<p>Give us your feedback, comments and ideas at https://github.com/astronomer/ask-astro/discussions</p>
</section>
</section>


                </article>
              

              
              
              
              
                <footer class="prev-next-footer">
                  <!-- Previous / next buttons -->
<div class="prev-next-area">
    <a class="left-prev"
       href="../api/setup_slack_bot.html"
       title="previous page">
      <i class="fa-solid fa-angle-left"></i>
      <div class="prev-next-info">
        <p class="prev-next-subtitle">previous</p>
        <p class="prev-next-title">Create an ask-astro Slack bot</p>
      </div>
    </a>
</div>
                </footer>
              
            </div>
            
            
              
                <div class="bd-sidebar-secondary bd-toc"><div class="sidebar-secondary-items sidebar-secondary__inner">

  <div class="sidebar-secondary-item">
  <div class="page-toc tocsection onthispage">
    <i class="fa-solid fa-list"></i> Contents
  </div>
  <nav class="bd-toc-nav page-toc">
    <ul class="visible nav section-nav flex-column">
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#ingest-and-embedding">Ingest and Embedding</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#prerequisites">Prerequisites</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#setup">Setup</a></li>
<li class="toc-h2 nav-item toc-entry"><a class="reference internal nav-link" href="#feedback">Feedback</a></li>
</ul>
  </nav></div>

</div></div>
              
            
          </div>
          <footer class="bd-footer-content">
            
<div class="bd-footer-content__inner container">
  
  <div class="footer-item">
    
<p class="component-author">
By astronomer.io
</p>

  </div>
  
  <div class="footer-item">
    
  <p class="copyright">
    
      Â© Copyright 2023, astronomer.io.
      <br/>
    
  </p>

  </div>
  
  <div class="footer-item">
    
  </div>
  
  <div class="footer-item">
    
  </div>
  
</div>
          </footer>
        

      </main>
    </div>
  </div>
  
  <!-- Scripts loaded after <body> so the DOM is not blocked -->
  <script src="../_static/scripts/bootstrap.js?digest=365ca57ee442770a23c6"></script>
<script src="../_static/scripts/pydata-sphinx-theme.js?digest=365ca57ee442770a23c6"></script>

  <footer class="bd-footer">
  </footer>
  </body>
</html>